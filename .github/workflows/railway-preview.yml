name: Railway

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: railway-pr-env-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
  LINK_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  DUPLICATE_FROM_ID: ${{ secrets.RAILWAY_DUPLICATE_FROM_ENV_ID }}
  SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}

  # Preview-only vars (ephemeral DB) 
  ENV_NAME_1: DATABASE_URL
  ENV_VALUE_1: ${{ secrets.PREVIEW_DATABASE_URL }}
  ENV_NAME_2: JWT_SECRET
  ENV_VALUE_2: ${{ secrets.PREVIEW_JWT_SECRET }}

jobs:
  pr_opened_or_updated:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    steps:
      - name: Link to Railway project + base env
        run: railway link --project ${{ env.LINK_PROJECT_ID }} --environment ${{ env.DUPLICATE_FROM_ID }}

      - name: Create or update PR environment
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"
          
          # Check if environment exists
          if railway environment list | grep -q "$ENV_NAME"; then
            echo "Environment $ENV_NAME already exists, updating..."
            railway link --environment "$ENV_NAME"
            railway variables set "${{ env.ENV_NAME_1 }}=${{ env.ENV_VALUE_1 }}" --service ${{ env.SERVICE_ID }}
            railway variables set "${{ env.ENV_NAME_2 }}=${{ env.ENV_VALUE_2 }}" --service ${{ env.SERVICE_ID }}
          else
            echo "Creating new environment $ENV_NAME..."
            railway environment new "$ENV_NAME" \
              --copy ${{ env.DUPLICATE_FROM_ID }} \
              --service-variable ${{ env.SERVICE_ID }} "${{ env.ENV_NAME_1 }}=${{ env.ENV_VALUE_1 }}" \
              --service-variable ${{ env.SERVICE_ID }} "${{ env.ENV_NAME_2 }}=${{ env.ENV_VALUE_2 }}" \
              --service-config ${{ env.SERVICE_ID }} "source.branch" "${{ github.head_ref }}"
          fi

      - name: Deploy to preview environment
        run: |
          railway link --environment "pr-${{ github.event.pull_request.number }}"
          railway up --service ${{ env.SERVICE_ID }} --detach

  pr_closed:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    steps:
      - name: Link to Railway project + base env
        run: railway link --project ${{ env.LINK_PROJECT_ID }} --environment ${{ env.DUPLICATE_FROM_ID }}

      - name: Delete PR environment
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"
          if railway environment list | grep -q "$ENV_NAME"; then
            echo "Deleting environment $ENV_NAME..."
            railway environment delete "$ENV_NAME" --yes || true
          else
            echo "Environment $ENV_NAME does not exist, skipping..."
          fi